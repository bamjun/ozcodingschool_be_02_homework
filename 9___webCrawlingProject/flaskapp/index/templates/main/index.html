<!DOCTYPE html>
<html lang="ko">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L1X6JW834X"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
    dataLayer.push(arguments);
    }
    gtag("js", new Date());

    gtag("config", "G-L1X6JW834X");
    </script>
  
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="{{ url_for('static', filename='book.ico') }}" />
    <title>TopBooksChartsğŸ˜¶â€ğŸŒ«ï¸{{ specific_date|safe }}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <style>
      html,
      body {
        background-color: rgb(255, 255, 238);
        margin: 0;
        padding: 0;
      }
      td {
        vertical-align: middle;
      }
      img {
        width: 50px;
      }
      p {
        margin: 0 !important;
        padding: 0 !important;
      }
      .chartcontainer {
        width: 100%;
      }
      #toggleLabels {
        width: 7%;
      }
      #input_date_index_group {
        display: flex;
        float: left;        
      }
      #toggleLabels {
        position: absolute;
        float: right;        
        left: 50%; /* ë²„íŠ¼ì„ ê°€ìš´ë° ì •ë ¬í•©ë‹ˆë‹¤. */
        transform: translateX(-50%); /* ì •í™•í•œ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ ì‚¬ìš©í•©ë‹ˆë‹¤. */
        padding: 10px;
        border: none;
        background-color: #007bff;
        color: white;
        cursor: pointer;
      }
      #myChart {
        margin-left: 1.5%;
        padding-right: 3%;
      }
      #toggleLabels {
        border-radius: 5px;
        margin: 5px;
      }

    </style>
  </head>
  <body>
    
    <select class="form-select" aria-label="Default select date" id="select_date">
      <option selected>ì¡°íšŒ ì›í•˜ëŠ” ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</option>
      {% for x in select_date %}
      <option value="{{ x }}">{{ x }}</option>
      {% endfor %}
    </select>

    <div class="chartcontainer">
      <div>
        <div id="input_date_index_group">
          <a
          class="social-icon__link"
          style="margin: 0; padding: 0;"
          target="_blank"
          href="https://github.com/bamjun/ozcodingschool_be_02_homework/tree/main/9___webCrawlingProject"
          >
            <ion-icon
            name="logo-github"
            style="color: rgb(207, 42, 207); font-size: 50px"
            ></ion-icon>
          </a>
          <div id="input_date_index"></div>
        </div>
        <button id="toggleLabels">ìˆ¨ê¸°ê¸°</button>
      </div>
      <canvas id="myChart"></canvas>
    </div>


    <div class="container mt-3">
      <div class="container mt-3">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th style="width: 60px"></th>
              <th></th>
              <th>
                <p>ì œëª© | í‰ì  | ë¦¬ë·°ìˆ˜ | ì‘ê°€ | ISBN | ì¶œíŒì‚¬ | ì¶œíŒì¼</p>
              </th>
              <th>
                <p>ì •ê°€ | íŒë§¤ê°€ | ì ë¦½ê¸ˆ</p>
              </th>
            </tr>
          </thead>
          <tbody id="data-table" class="table-group-divider">
            {% for book, price, rank in books_info.items %}
            <tr
              data-href="{{ price.kyobourl }}"
              style="cursor: pointer"
              onclick="window.open(this.getAttribute('data-href'), '_blank');"
            >
              <td><img src="{{ book.coverurl }}" /></td>
              <td>
                <p>{{ rank.kyoborank }}</p>
                <p>{{ rank.kyoboupdown }}</p>
              </td>
              <td>
                <p>
                  {{ book.title }} | {{ rank.kyoborating }} | {{
                  rank.kyoboreview }}
                </p>
                <p>{{ book.author }}</p>
                <p>
                  {{ book.isbn }} | {{ book.publisher }} | {{ book.publishing }}
                </p>
              </td>
              <td>
                <p>{{ price.kyoboprice }}</p>
                <p>{{ price.kyobosaleprice }}</p>
                <p>{{ price.kyobopoint }}</p>
              </td>
            </tr>

            {% endfor %}

            <!-- ì¶”í›„ í¬ë¡¤ë§í•œ ë°ì´í„°ê°€ ë“¤ì–´ê°€ëŠ” ìë¦¬ -->
          </tbody>
        </table>
      </div>
      <a id="here"></a>
      <!-- í˜ì´ì§€ ë„¤ì´ì…˜ ì½”ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš” -->
      <nav aria-label="...">
        <!-- í˜ì´ì§•ì²˜ë¦¬ ì‹œì‘ -->
        <ul class="pagination justify-content-center">
          <!-- ì´ì „í˜ì´ì§€ -->
          {% if books_info.has_prev %}
          <li class="page-item">
            <a class="page-link" href="?page={{ books_info.prev_num }}#here"
              >ì´ì „</a
            >
          </li>
          {% else %}
          <li class="page-item disabled">
            <a
              class="page-link"
              tabindex="-1"
              aria-disabled="true"
              href="javascript:void(0)"
              >ì´ì „</a
            >
          </li>
          {% endif %}
          <!-- í˜ì´ì§€ë²ˆí˜¸ -->
          {% for page_num in books_info.iter_pages() %} {% if page_num %} {% if
          page_num != books_info.page %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_num }}#here"
              >{{ page_num }}</a
            >
          </li>
          {% else %}
          <li class="page-item active" aria-current="page">
            <a class="page-link" href="javascript:void(0)">{{ page_num }}</a>
          </li>
          {% endif %} {% else %}
          <li class="disabled">
            <a class="page-link" href="javascript:void(0)">...</a>
          </li>
          {% endif %} {% endfor %}
          <!-- ë‹¤ìŒí˜ì´ì§€ -->
          {% if books_info.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ books_info.next_num }}#here"
              >ë‹¤ìŒ</a
            >
          </li>
          {% else %}
          <li class="page-item disabled">
            <a
              class="page-link"
              tabindex="-1"
              aria-disabled="true"
              href="javascript:void(0)"
              >ë‹¤ìŒ</a
            >
          </li>
          {% endif %}
        </ul>
        <!-- í˜ì´ì§•ì²˜ë¦¬ ë -->
      </nav>
    </div>

    <script>
      // select ìš”ì†Œì˜ ë³€ê²½ ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•˜ì—¬ í˜ì´ì§€ ì´ë™
      document.getElementById('select_date').addEventListener('change', function() {
        // ì„ íƒëœ ì˜µì…˜ì˜ ê°’ ê°€ì ¸ì˜¤ê¸°
        var selectedValue = this.value;
        // ì„ íƒëœ ê°’ì— ë”°ë¼ ì ì ˆí•œ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = '/detail/' + selectedValue; // ì´ë™í•  í˜ì´ì§€ URL
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script>

      const data = JSON.parse('{{ data|safe }}');
      const crawltime = '{{ specific_date|safe }}'

      let minR = Math.min(
        ...data.datasets.flatMap((dataset) =>
          dataset.data.map((item) => item.r)
        )
      );
      let maxR = Math.max(
        ...data.datasets.flatMap((dataset) =>
          dataset.data.map((item) => item.r)
        )
      );

      // r ê°’ì„ 1ì—ì„œ 100 ì‚¬ì´ì˜ ë°±ë¶„ìœ¨ë¡œ ìŠ¤ì¼€ì¼ë§
      data.datasets.forEach((dataset) => {
        dataset.data.forEach((item) => {
          item.r = scaleToRange(item.r, minR, maxR, 5, 100);
        });
      });

      function scaleToRange(value, min, max, newMin, newMax) {
        return ((value - min) / (max - min)) * (newMax - newMin) + newMin;
      }

      // ë†’ë‚®ì´ ìŠ¤ì¼€ì¼ë¡œ ì¡°ì • ì‹œì‘
      // let maxY = 0;
      // data.datasets.forEach((dataset) => {
      //   dataset.data.forEach((item) => {
      //     if (item.y > maxY) {
      //       maxY = item.y;
      //     }
      //   });
      // });
      // maxY += 1; // ìµœëŒ€ yê°’ë³´ë‹¤ 1 ë†’ê²Œ ì„¤ì •

      // let minY = Infinity; // minYë¥¼ ë¬´í•œëŒ€ë¡œ ì´ˆê¸°í™”í•˜ì—¬, ë¹„êµ ì‹œì‘ì‹œ ëª¨ë“  ê°’ì´ ë” ì‘ê²Œ ì„¤ì •ë˜ë„ë¡ í•©ë‹ˆë‹¤.

      // data.datasets.forEach((dataset) => {
      //   dataset.data.forEach((item) => {
      //     if (item.y < minY) {
      //       // ê° ì•„ì´í…œì˜ y ê°’ì´ í˜„ì¬ minYë³´ë‹¤ ì‘ì€ì§€ ë¹„êµ
      //       minY = item.y; // ë” ì‘ì€ ê°’ì„ ì°¾ìœ¼ë©´ minYë¥¼ ì—…ë°ì´íŠ¸
      //     }
      //   });
      // });

      // minY -= 1; // ìµœì†Œ yê°’ë³´ë‹¤ 1 ë‚®ê²Œ ì„¤ì •

      // data.datasets.forEach((dataset) => {
      //   dataset.data.forEach((item) => {
      //     item.y = scaleToRange(item.y, minY, maxY, -48, 48);
      //   });
      // });
      // ë†’ë‚®ì´ ìŠ¤ì¼€ì¼ë¡œ ì¡°ì • ë

      const config = {
        type: "bubble",
        data: data,
        options: {
          layout: {
            autoPadding: false,
            padding: 10,
          },
          responsive: true,
          plugins: {
            tooltip: {
              enabled: true,
              callbacks: {
                label: function(context) {
                  // ë°ì´í„° í¬ì¸íŠ¸ì˜ `tooltip` ì†ì„±ì— ì ‘ê·¼
                  const tooltipLabel = context.raw.tooltip;
                  return tooltipLabel;
                }
              }
            },
            // ë¼ë²¨í‘œì‹œ
            legend: {
              display: true,
              position: 'top',
            },
            title: false,
          },
          scales: {
            x: {
              // type: "linear",
              // position: "bottom",
              min: 100, // xì¶•ì˜ ìµœì†Œê°’ ì„¤ì •
              max: 0, // xì¶•ì˜ ìµœëŒ€ê°’ ì„¤ì •
              reverse: true, // xì¶•ì˜ ìˆœì„œë¥¼ ë’¤ì§‘ìŒ
              title: {
                display: true,
                text: "ìˆœìœ„ ( ë²„ë¸”í¬ê¸° : ë¦¬ë·°ìˆ˜ )", // xì¶• ì„¤ëª…
              },
            },
            y: {
              min: -55, // xì¶•ì˜ ìµœì†Œê°’ ì„¤ì •
              max: 55, // xì¶•ì˜ ìµœëŒ€ê°’ ì„¤ì •
              reverse: false, // xì¶•ì˜ ìˆœì„œë¥¼ ë’¤ì§‘ìŒ
              title: {
                display: true,
                text: "ê¸‰ë“±", // yì¶• ì„¤ëª…
              },
            },
          },
        },
      };

      const ctx = document.getElementById("myChart");

      const booksbubblechart = new Chart(ctx, config);

      booksbubblechart.canvas.onclick = clickBubble;

      function clickBubble(click) {
        // console.log(click);
        const points = booksbubblechart.getElementsAtEventForMode(
          click,
          "nearest",
          { intersect: true },
          true
        );

        if (points.length) {
          const datasetIndex = points[0].datasetIndex;
          const dataPoint = points[0].index;
          const link =
            booksbubblechart.data.datasets[datasetIndex].data[dataPoint].link;
          window.open(link, "_blank");
        }
      }
      document.getElementById('input_date_index').textContent = 'ğŸ¦„ ' + crawltime

      // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
      document.getElementById('toggleLabels').addEventListener('click', function() {
        let toggleLabels_button = this
        let isHidden_index
        if (toggleLabels_button.textContent != 'ìˆ¨ê¸°ê¸°') {
          toggleLabels_button.textContent = 'ìˆ¨ê¸°ê¸°';
          isHidden_index = true
        } else {
          toggleLabels_button.textContent = 'ë³´ì´ê¸°';
          isHidden_index = false
        }
        
        data.datasets.forEach((dataset, index) => {
          booksbubblechart.setDatasetVisibility(index, isHidden_index); // ëª¨ë“  ë°ì´í„° ì„¸íŠ¸ë¥¼ í‘œì‹œí•˜ê±°ë‚˜ ìˆ¨ê¹ë‹ˆë‹¤.
        });
        booksbubblechart.update(); // ì°¨íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ë³€ê²½ì‚¬í•­ì„ ì ìš©í•©ë‹ˆë‹¤.
        
      });


    </script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  </body>
</html>
