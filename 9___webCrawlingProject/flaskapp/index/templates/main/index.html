<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="{{ url_for('static', filename='book.ico') }}" />
    <title>TopBooksCharts</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <style>
      html,
      body {
        background-color: rgb(255, 255, 238);
        margin: 0;
        padding: 0;
      }
      td {
        vertical-align: middle;
      }
      img {
        width: 50px;
      }
      p {
        margin: 0 !important;
        padding: 0 !important;
      }
      .chartcontainer {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="chartcontainer">
      <canvas id="myChart"></canvas>
    </div>

    <div class="container mt-3">
      <div class="container mt-3">
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th style="width: 60px"></th>
              <th></th>
              <th>
                <p>제목 | 평점 | 리뷰수 | 작가 | ISBN | 출판사 | 출판일</p>
              </th>
              <th>
                <p>정가 | 판매가 | 적립금</p>
              </th>
            </tr>
          </thead>
          <tbody id="data-table" class="table-group-divider">
            {% for book, price, rank in books_info.items %}
            <tr
              data-href="{{ price.kyobourl }}"
              style="cursor: pointer"
              onclick="window.open(this.getAttribute('data-href'), '_blank');"
            >
              <td><img src="{{ book.coverurl }}" /></td>
              <td>
                <p>{{ rank.kyoborank }}</p>
                <p>{{ rank.kyoboupdown }}</p>
              </td>
              <td>
                <p>
                  {{ book.title }} | {{ rank.kyoborating }} | {{
                  rank.kyoboreview }}
                </p>
                <p>{{ book.author }}</p>
                <p>
                  {{ book.isbn }} | {{ book.publisher }} | {{ book.publishing }}
                </p>
              </td>
              <td>
                <p>{{ price.kyoboprice }}</p>
                <p>{{ price.kyobosaleprice }}</p>
                <p>{{ price.kyobopoint }}</p>
              </td>
            </tr>

            {% endfor %}

            <!-- 추후 크롤링한 데이터가 들어가는 자리 -->
          </tbody>
        </table>
      </div>
      <a id="here"></a>
      <!-- 페이지 네이션 코드를 넣어주세요 -->
      <nav aria-label="...">
        <!-- 페이징처리 시작 -->
        <ul class="pagination justify-content-center">
          <!-- 이전페이지 -->
          {% if books_info.has_prev %}
          <li class="page-item">
            <a class="page-link" href="?page={{ books_info.prev_num }}#here"
              >이전</a
            >
          </li>
          {% else %}
          <li class="page-item disabled">
            <a
              class="page-link"
              tabindex="-1"
              aria-disabled="true"
              href="javascript:void(0)"
              >이전</a
            >
          </li>
          {% endif %}
          <!-- 페이지번호 -->
          {% for page_num in books_info.iter_pages() %} {% if page_num %} {% if
          page_num != books_info.page %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_num }}#here"
              >{{ page_num }}</a
            >
          </li>
          {% else %}
          <li class="page-item active" aria-current="page">
            <a class="page-link" href="javascript:void(0)">{{ page_num }}</a>
          </li>
          {% endif %} {% else %}
          <li class="disabled">
            <a class="page-link" href="javascript:void(0)">...</a>
          </li>
          {% endif %} {% endfor %}
          <!-- 다음페이지 -->
          {% if books_info.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ books_info.next_num }}#here"
              >다음</a
            >
          </li>
          {% else %}
          <li class="page-item disabled">
            <a
              class="page-link"
              tabindex="-1"
              aria-disabled="true"
              href="javascript:void(0)"
              >다음</a
            >
          </li>
          {% endif %}
        </ul>
        <!-- 페이징처리 끝 -->
      </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>

      const data = JSON.parse('{{ data|safe }}');
      const crawltime = '{{ specific_date|safe }}'

      let minR = Math.min(
        ...data.datasets.flatMap((dataset) =>
          dataset.data.map((item) => item.r)
        )
      );
      let maxR = Math.max(
        ...data.datasets.flatMap((dataset) =>
          dataset.data.map((item) => item.r)
        )
      );

      // r 값을 1에서 100 사이의 백분율로 스케일링
      data.datasets.forEach((dataset) => {
        dataset.data.forEach((item) => {
          item.r = scaleToRange(item.r, minR, maxR, 5, 100);
        });
      });

      function scaleToRange(value, min, max, newMin, newMax) {
        return ((value - min) / (max - min)) * (newMax - newMin) + newMin;
      }

      // 높낮이 스케일로 조정 시작
      // let maxY = 0;
      // data.datasets.forEach((dataset) => {
      //   dataset.data.forEach((item) => {
      //     if (item.y > maxY) {
      //       maxY = item.y;
      //     }
      //   });
      // });
      // maxY += 1; // 최대 y값보다 1 높게 설정

      // let minY = Infinity; // minY를 무한대로 초기화하여, 비교 시작시 모든 값이 더 작게 설정되도록 합니다.

      // data.datasets.forEach((dataset) => {
      //   dataset.data.forEach((item) => {
      //     if (item.y < minY) {
      //       // 각 아이템의 y 값이 현재 minY보다 작은지 비교
      //       minY = item.y; // 더 작은 값을 찾으면 minY를 업데이트
      //     }
      //   });
      // });

      // minY -= 1; // 최소 y값보다 1 낮게 설정

      // data.datasets.forEach((dataset) => {
      //   dataset.data.forEach((item) => {
      //     item.y = scaleToRange(item.y, minY, maxY, -48, 48);
      //   });
      // });
      // 높낮이 스케일로 조정 끝

      const config = {
        type: "bubble",
        data: data,
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function (context) {
                  // context 객체에서 필요한 데이터를 추출
                  let label = context.dataset.label || "";
                  return label;
                },
              },
            },

            legend: false,
            title: {
              display: true,
              text: "급상승 버블차트 🦄" + crawltime,
            },
          },
          scales: {
            x: {
              // type: "linear",
              // position: "bottom",
              min: 100, // x축의 최소값 설정
              max: 0, // x축의 최대값 설정
              reverse: true, // x축의 순서를 뒤집음
              title: {
                display: true,
                text: "순위 ( 버블크기 : 리뷰수 )", // x축 설명
              },
            },
            y: {
              min: -55, // x축의 최소값 설정
              max: 55, // x축의 최대값 설정
              reverse: false, // x축의 순서를 뒤집음
              title: {
                display: true,
                text: "급등", // y축 설명
              },
            },
          },
        },
      };

      const ctx = document.getElementById("myChart");

      const booksbubblechart = new Chart(ctx, config);

      booksbubblechart.canvas.onclick = clickBubble;

      function clickBubble(click) {
        console.log(click);
        const points = booksbubblechart.getElementsAtEventForMode(
          click,
          "nearest",
          { intersect: true },
          true
        );

        if (points.length) {
          const datasetIndex = points[0].datasetIndex;
          const dataPoint = points[0].index;
          const link =
            booksbubblechart.data.datasets[datasetIndex].data[dataPoint].link;
          window.open(link, "_blank");
        }
      }
    </script>
  </body>
</html>
